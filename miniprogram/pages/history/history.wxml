<!-- pages/history/history.wxml -->
<view class="page-container">
  <!-- ä¹ æƒ¯ä¿¡æ¯å¤´éƒ¨ -->
  <view
    class="habit-header"
    wx:if="{{habit}}"
    style="background: linear-gradient(135deg, {{habit.color || '#6C5CE7'}} 0%, {{habit.color || '#6C5CE7'}}CC 100%)"
  >
    <view class="habit-icon-wrapper">
      <text class="habit-icon">{{habit.icon || 'ğŸ¯'}}</text>
    </view>
    <view class="habit-info">
      <text class="habit-name">{{habit.name}}</text>
      <text class="habit-desc" wx:if="{{habit.description}}">{{habit.description}}</text>
    </view>
  </view>

  <!-- ç»Ÿè®¡å¡ç‰‡ -->
  <view class="stats-row">
    <view class="stat-card">
      <text class="stat-value">{{completedDays}}</text>
      <text class="stat-label">å®Œæˆå¤©æ•°</text>
    </view>
    <view class="stat-card">
      <text class="stat-value">{{currentStreak}}</text>
      <text class="stat-label">è¿ç»­å¤©æ•°</text>
    </view>
    <view class="stat-card">
      <text class="stat-value">{{completionRate}}%</text>
      <text class="stat-label">å®Œæˆç‡</text>
    </view>
  </view>

  <!-- æ—¥å†è§†å›¾ -->
  <view class="calendar-section">
    <calendar
      checkInData="{{checkInData}}"
      color="{{habit.color || '#6C5CE7'}}"
      selectedDate="{{selectedDate}}"
      bind:dateselect="onDateSelect"
      bind:monthchange="onMonthChange"
    />
  </view>

  <!-- é€‰ä¸­æ—¥æœŸçš„æ‰“å¡è¯¦æƒ… -->
  <view class="selected-detail" bindtap="onCheckInTap">
    <view class="detail-header">
      <text class="detail-date">{{selectedDate}}</text>
      <view class="detail-action">
        <text class="action-text">{{selectedCheckIn ? 'ç¼–è¾‘' : 'æ‰“å¡'}}</text>
        <text class="action-icon">â€º</text>
      </view>
    </view>

    <view wx:if="{{selectedCheckIn}}" class="detail-content">
      <view class="detail-status">
        <view
          class="status-badge {{selectedCheckIn.completed ? 'completed' : 'incomplete'}}"
          style="{{selectedCheckIn.completed ? 'background-color: ' + (habit.color || '#6C5CE7') : ''}}"
        >
          <text class="status-icon">{{selectedCheckIn.completed ? 'âœ“' : 'â—‹'}}</text>
          <text class="status-text">{{selectedCheckIn.completed ? 'å·²å®Œæˆ' : 'æœªå®Œæˆ'}}</text>
        </view>
        <text class="detail-value" wx:if="{{selectedCheckIn.value}}">
          {{selectedCheckIn.value}} {{habit.unit || ''}}
        </text>
      </view>
      <view class="detail-note" wx:if="{{selectedCheckIn.note}}">
        <text class="note-icon">ğŸ“</text>
        <text class="note-text">{{selectedCheckIn.note}}</text>
      </view>
    </view>

    <view wx:else class="detail-empty">
      <text class="empty-icon">ğŸ“…</text>
      <text class="empty-text">ç‚¹å‡»æ·»åŠ æ‰“å¡è®°å½•</text>
    </view>
  </view>

  <!-- æœ€è¿‘æ‰“å¡è®°å½•åˆ—è¡¨ -->
  <view class="history-section" wx:if="{{checkIns.length > 0}}">
    <view class="section-header">
      <text class="section-title">æ‰“å¡è®°å½•</text>
      <text class="section-count">å…± {{completedDays}} æ¬¡</text>
    </view>

    <view class="history-list">
      <view
        wx:for="{{checkIns}}"
        wx:key="_id"
        class="history-item {{item.completed ? 'completed' : ''}}"
        data-date="{{item.date}}"
        bindtap="onHistoryItemTap"
      >
        <view class="item-left">
          <view
            class="item-dot"
            style="{{item.completed ? 'background-color: ' + (habit.color || '#6C5CE7') : ''}}"
          ></view>
          <view class="item-info">
            <text class="item-date">{{item.date}}</text>
            <text class="item-note" wx:if="{{item.note}}">{{item.note}}</text>
          </view>
        </view>
        <view class="item-right">
          <text class="item-value" wx:if="{{item.value}}">{{item.value}} {{habit.unit || ''}}</text>
          <text class="item-status">{{item.completed ? 'âœ“' : 'â—‹'}}</text>
        </view>
      </view>
    </view>
  </view>

  <!-- ç©ºçŠ¶æ€ -->
  <view wx:if="{{!loading && checkIns.length === 0}}" class="empty-state">
    <view class="empty-illustration">
      <text class="empty-emoji">ğŸ“Š</text>
    </view>
    <text class="empty-title">æš‚æ— æ‰“å¡è®°å½•</text>
    <text class="empty-desc">åœ¨æ—¥å†ä¸Šé€‰æ‹©æ—¥æœŸå¼€å§‹è®°å½•å§</text>
  </view>

  <!-- åŠ è½½çŠ¶æ€ -->
  <view wx:if="{{loading}}" class="loading-container">
    <view class="loading-spinner"></view>
    <text class="loading-text">åŠ è½½ä¸­...</text>
  </view>
</view>
